<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakEasy - AI Language Tutor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --accent: #10b981;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --user-bubble: #2563eb;
            --teacher-bubble: #f1f5f9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        .app {
            display: grid;
            grid-template-columns: 380px 1fr;
            height: 100vh;
        }

        /* Teacher Panel */
        .teacher-panel {
            background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1.5rem;
        }

        .teacher-avatar {
            width: 260px;
            height: 260px;
            margin: 2rem 0;
        }

        .mouth { transition: all 0.08s ease; }
        .mouth.talking {
            animation: talk 0.12s infinite alternate;
        }

        @keyframes talk {
            0% { 
                d: path('M 130 210 Q 160 230 190 210');
                transform: scaleY(1);
            }
            100% { 
                d: path('M 130 210 Q 160 240 190 210');
                transform: scaleY(1.1);
            }
        }

        .mouth.talking #teacherTongue {
            animation: tongueMove 0.12s infinite alternate;
        }

        @keyframes tongueMove {
            0% { 
                rx: 8; 
                ry: 4;
                opacity: 0.8;
            }
            100% { 
                rx: 10; 
                ry: 5;
                opacity: 1;
            }
        }

        .teacher-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .teacher-status {
            font-size: 0.875rem;
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border-radius: 20px;
            margin-bottom: 2rem;
        }

        .teacher-status.speaking {
            color: var(--accent);
            font-weight: 500;
        }

        .language-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Main Chat Area */
        .chat-area {
            display: flex;
            flex-direction: column;
            background: var(--bg);
        }

        .chat-header {
            background: var(--card-bg);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--border);
        }

        /* Transcript Area */
        .transcript-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 2rem;
        }

        .transcript {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .transcript-line {
            display: flex;
            gap: 1rem;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .transcript-line.user {
            flex-direction: row-reverse;
        }

        .speaker-label {
            min-width: 100px;
            font-weight: 600;
            font-size: 0.875rem;
            padding-top: 0.25rem;
        }

        .speaker-label.teacher {
            color: var(--accent);
        }

        .speaker-label.you {
            color: var(--primary);
            text-align: right;
        }

        .transcript-text {
            flex: 1;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 0.9375rem;
        }

        .transcript-line.teacher .transcript-text {
            background: var(--teacher-bubble);
            border-left: 3px solid var(--accent);
        }

        .transcript-line.user .transcript-text {
            background: var(--user-bubble);
            color: white;
            border-right: 3px solid var(--primary-dark);
        }

        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: scale(1); opacity: 0.4; }
            30% { transform: scale(1.2); opacity: 1; }
        }

        /* Input Area */
        .input-area {
            background: var(--card-bg);
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            gap: 1rem;
        }

        .input-field {
            flex: 1;
            padding: 1rem 1.5rem;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .send-btn {
            width: 52px;
            height: 52px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Onboarding Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 3rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .modal-header h2 {
            font-size: 1.75rem;
            margin-bottom: 0.75rem;
        }

        .modal-header p {
            color: var(--text-muted);
        }

        .onboarding-step {
            display: none;
        }

        .onboarding-step.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .language-select-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .language-option {
            padding: 1rem;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 0.9375rem;
        }

        .language-option:hover {
            border-color: var(--primary);
        }

        .language-option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .auth-btn {
            padding: 1rem;
            border: 2px solid var(--border);
            background: var(--card-bg);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9375rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: all 0.2s;
        }

        .auth-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .btn-primary {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .divider {
            text-align: center;
            margin: 1rem 0;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        @media (max-width: 968px) {
            .app { grid-template-columns: 1fr; }
            .teacher-panel { display: none; }
        }
    </style>
</head>
<body>
    <!-- Onboarding Modal -->
    <div class="modal active" id="onboardingModal">
        <div class="modal-content">
            <!-- Step 1: Auth -->
            <div class="onboarding-step active" id="step-auth">
                <div class="modal-header">
                    <h2>Welcome to SpeakEasy 🗣️</h2>
                    <p>Sign in to save your progress and continue learning</p>
                </div>
                <div class="auth-buttons">
                    <button class="auth-btn" onclick="loginWithGoogle()">
                        <svg width="20" height="20" viewBox="0 0 20 20"><path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/><path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/><path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/><path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/></svg>
                        Continue with Google
                    </button>
                    <button class="auth-btn" onclick="loginWithApple()">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path d="M15.769 1.29c-1.217.04-2.669.833-3.529 1.846-.775.913-1.417 2.326-1.232 3.686 1.372.049 2.777-.742 3.589-1.767.774-.975 1.344-2.345 1.172-3.765zM17.5 6.685c-2.107-.12-3.906 1.199-4.91 1.199-1.006 0-2.557-1.136-4.207-1.104-2.162.032-4.162 1.26-5.277 3.202-2.249 3.897-.576 9.673 1.614 12.84 1.072 1.55 2.348 3.29 4.031 3.227 1.619-.064 2.233-1.047 4.191-1.047 1.957 0 2.506 1.047 4.207 1.015 1.748-.032 2.862-1.581 3.934-3.132 1.237-1.792 1.748-3.526 1.78-3.622-.039-.016-3.414-1.31-3.447-5.199-.032-3.258 2.666-4.821 2.792-4.917-1.52-2.23-3.89-2.475-4.708-2.522z"/></svg>
                        Continue with Apple
                    </button>
                </div>
                <div class="divider">or</div>
                <button class="auth-btn" style="border-style: dashed;" onclick="continueAsGuest()">
                    Continue as Guest
                </button>
            </div>

            <!-- Step 2: Profile Info -->
            <div class="onboarding-step" id="step-profile">
                <div class="modal-header">
                    <h2>Let's personalize your learning</h2>
                    <p>This helps us create the perfect experience for you</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Your Name</label>
                    <input type="text" class="form-input" id="userName" placeholder="e.g., Sarah">
                </div>
                <div class="form-group">
                    <label class="form-label">Native Language</label>
                    <input type="text" class="form-input" id="nativeLang" placeholder="e.g., English">
                </div>
                <div class="form-group">
                    <label class="form-label">I want to learn...</label>
                    <div class="language-select-grid">
                        <div class="language-option" onclick="selectTargetLang(this)" data-lang="Spanish">🇪🇸 Spanish</div>
                        <div class="language-option" onclick="selectTargetLang(this)" data-lang="French">🇫🇷 French</div>
                        <div class="language-option" onclick="selectTargetLang(this)" data-lang="German">🇩🇪 German</div>
                        <div class="language-option" onclick="selectTargetLang(this)" data-lang="Italian">🇮🇹 Italian</div>
                        <div class="language-option" onclick="selectTargetLang(this)" data-lang="Portuguese">🇵🇹 Portuguese</div>
                        <div class="language-option" onclick="selectTargetLang(this)" data-lang="Japanese">🇯🇵 Japanese</div>
                    </div>
                </div>
                <button class="btn-primary" onclick="completeOnboarding()" id="completeBtn" disabled>
                    Start Learning
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app" id="mainApp" style="display: none;">
        <!-- Teacher Panel -->
        <div class="teacher-panel">
            <div class="teacher-name">Your AI Teacher</div>
            <div class="teacher-avatar">
                <svg viewBox="0 0 320 320" xmlns="http://www.w3.org/2000/svg">
                    <!-- Face -->
                    <circle cx="160" cy="160" r="140" fill="#fcd5b5"/>
                    
                    <!-- Hair (bob cut with waves) -->
                    <path d="M 160 20 Q 200 15 240 30 Q 250 50 245 80 Q 240 100 220 110 Q 200 120 180 125 Q 160 130 140 125 Q 120 120 100 110 Q 80 100 75 80 Q 70 50 80 30 Q 120 15 160 20 Z" fill="#8b4513"/>
                    <path d="M 70 80 Q 90 70 110 75 Q 130 80 150 85 Q 170 90 190 85 Q 210 80 230 75 Q 250 70 270 80" fill="#8b4513"/>
                    
                    <!-- Glasses (black frames) -->
                    <circle cx="120" cy="145" r="32" fill="none" stroke="#000000" stroke-width="4"/>
                    <circle cx="200" cy="145" r="32" fill="none" stroke="#000000" stroke-width="4"/>
                    <line x1="152" y1="145" x2="168" y2="145" stroke="#000000" stroke-width="4"/>
                    
                    <!-- Eyes (light brown) -->
                    <circle cx="120" cy="145" r="12" fill="#d2b48c"/>
                    <circle cx="200" cy="145" r="12" fill="#d2b48c"/>
                    <circle cx="120" cy="145" r="8" fill="#8b4513"/>
                    <circle cx="200" cy="145" r="8" fill="#8b4513"/>
                    <circle cx="122" cy="143" r="2" fill="white"/>
                    <circle cx="202" cy="143" r="2" fill="white"/>
                    
                    <!-- Eyebrows (dark brown) -->
                    <path d="M 88 125 Q 120 120 145 125" stroke="#654321" stroke-width="3" fill="none" stroke-linecap="round"/>
                    <path d="M 175 125 Q 200 120 232 125" stroke="#654321" stroke-width="3" fill="none" stroke-linecap="round"/>
                    
                    <!-- Nose -->
                    <path d="M 160 160 L 160 185" stroke="#d4a574" stroke-width="2.5" fill="none"/>
                    <path d="M 153 185 Q 160 188 167 185" stroke="#d4a574" stroke-width="2" fill="none"/>
                    
                    <!-- Mouth (ANIMATED - wide smile with tongue) -->
                    <path id="teacherMouth" class="mouth" d="M 130 210 Q 160 230 190 210" stroke="#c97064" stroke-width="4" fill="none" stroke-linecap="round"/>
                    <ellipse id="teacherTongue" class="mouth" cx="160" cy="215" rx="8" ry="4" fill="#ff69b4" opacity="0.8"/>
                    
                    <!-- Blush (pink) -->
                    <ellipse cx="100" cy="175" rx="18" ry="12" fill="#ffb6c1" opacity="0.6"/>
                    <ellipse cx="220" cy="175" rx="18" ry="12" fill="#ffb6c1" opacity="0.6"/>
                    
                    <!-- Neck -->
                    <rect x="140" y="285" width="40" height="35" fill="#fcd5b5"/>
                    
                    <!-- White Collar -->
                    <path d="M 120 300 L 140 320 L 180 320 L 200 300 L 190 290 L 130 290 Z" fill="white"/>
                    
                    <!-- Dark Green V-neck Top -->
                    <path d="M 130 290 Q 160 285 190 290 L 200 300 L 180 320 L 140 320 L 120 300 Z" fill="#2d5016"/>
                    
                    <!-- Red Apple Pin -->
                    <circle cx="140" cy="300" r="6" fill="#ff0000"/>
                    <path d="M 140 294 Q 142 292 144 294" stroke="#228b22" stroke-width="2" fill="none"/>
                    
                    <!-- Earrings -->
                    <circle cx="88" cy="160" r="3" fill="white"/>
                    <circle cx="232" cy="160" r="3" fill="white"/>
                </svg>
            </div>
            <div class="teacher-status" id="teacherStatus">Ready to help!</div>
            <div class="language-badge" id="languageBadge">
                <span>🇪🇸</span>
                <span id="currentLangName">Spanish</span>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-title">Practice Conversation</div>
                <div class="user-menu">
                    <button class="icon-btn" onclick="clearChat()" title="Clear">🗑️</button>
                    <div class="user-avatar-small" id="userAvatar" onclick="logout()">U</div>
                </div>
            </div>

            <div class="transcript-container">
                <div class="transcript" id="transcript">
                    <div class="transcript-line teacher">
                        <div class="speaker-label teacher">Teacher</div>
                        <div class="transcript-text">
                            Hi! I'm your AI language tutor. Type a message below and I'll help you practice!
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <textarea 
                        class="input-field" 
                        id="messageInput" 
                        placeholder="Type your message..."
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">➤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://speakeasy-backend-823510409781.us-central1.run.app';
        let user = null;
        let profile = null;
        let sessionId = null;
        let selectedTargetLang = null;

        // Load saved user
        async function loadUser() {
            const savedSession = localStorage.getItem('speakeasy_session');
            const savedUser = localStorage.getItem('speakeasy_user');
            const savedProfile = localStorage.getItem('speakeasy_profile');
            
            if (savedSession && savedUser && savedProfile) {
                try {
                    // Verify session with server
                    const response = await fetch(`${API_URL}/api/auth/session/${savedSession}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        user = data.user;
                        profile = data.user.profile || JSON.parse(savedProfile);
                        sessionId = savedSession;
                        showMainApp();
                    } else {
                        // Session expired, clear local storage
                        localStorage.removeItem('speakeasy_session');
                        localStorage.removeItem('speakeasy_user');
                        localStorage.removeItem('speakeasy_profile');
                    }
                } catch (error) {
                    console.error('Session verification failed:', error);
                    // Fallback to local storage
                    user = JSON.parse(savedUser);
                    profile = JSON.parse(savedProfile);
                    showMainApp();
                }
            }
        }

        loadUser();

        // Auth Functions
        async function loginWithGoogle() {
            try {
                // Simulate Google OAuth (in production, use Google OAuth)
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: 'google',
                        name: 'Google User',
                        email: 'user@gmail.com'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    user = data.user;
                    sessionId = data.sessionId;
                    localStorage.setItem('speakeasy_session', sessionId);
                    nextStep('auth', 'profile');
                } else {
                    alert('Login failed. Please try again.');
                }
            } catch (error) {
                console.error('Google login error:', error);
                alert('Login failed. Please try again.');
            }
        }

        async function loginWithApple() {
            try {
                // Simulate Apple OAuth (in production, use Apple OAuth)
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: 'apple',
                        name: 'Apple User',
                        email: 'user@icloud.com'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    user = data.user;
                    sessionId = data.sessionId;
                    localStorage.setItem('speakeasy_session', sessionId);
                    nextStep('auth', 'profile');
                } else {
                    alert('Login failed. Please try again.');
                }
            } catch (error) {
                console.error('Apple login error:', error);
                alert('Login failed. Please try again.');
            }
        }

        async function continueAsGuest() {
            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: 'guest',
                        name: 'Guest User'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    user = data.user;
                    sessionId = data.sessionId;
                    localStorage.setItem('speakeasy_session', sessionId);
                    nextStep('auth', 'profile');
                } else {
                    alert('Guest login failed. Please try again.');
                }
            } catch (error) {
                console.error('Guest login error:', error);
                alert('Guest login failed. Please try again.');
            }
        }

        function selectTargetLang(elem) {
            document.querySelectorAll('.language-option').forEach(e => e.classList.remove('selected'));
            elem.classList.add('selected');
            selectedTargetLang = elem.dataset.lang;
            document.getElementById('completeBtn').disabled = !document.getElementById('userName').value || !selectedTargetLang;
        }

        // Enable complete button when name and language are filled
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('userName');
            if (nameInput) {
                nameInput.addEventListener('input', () => {
                    document.getElementById('completeBtn').disabled = !nameInput.value || !selectedTargetLang;
                });
            }
        });

        async function completeOnboarding() {
            const userName = document.getElementById('userName').value.trim();
            const nativeLang = document.getElementById('nativeLang').value.trim() || 'English';
            
            if (!userName || !selectedTargetLang) return;

            profile = {
                name: userName,
                nativeLanguage: nativeLang,
                targetLanguage: selectedTargetLang,
                level: 'beginner',
                createdAt: Date.now()
            };

            try {
                // Save profile to server
                const response = await fetch(`${API_URL}/api/auth/profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        profile: profile
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    // Update local storage
                    localStorage.setItem('speakeasy_user', JSON.stringify(user));
                    localStorage.setItem('speakeasy_profile', JSON.stringify(profile));
                    localStorage.setItem('speakeasy_session', sessionId);
                    
                    showMainApp();
                } else {
                    alert('Failed to save profile. Please try again.');
                }
            } catch (error) {
                console.error('Profile save error:', error);
                alert('Failed to save profile. Please try again.');
            }
        }

        function nextStep(current, next) {
            document.getElementById(`step-${current}`).classList.remove('active');
            document.getElementById(`step-${next}`).classList.add('active');
        }

        function showMainApp() {
            document.getElementById('onboardingModal').classList.remove('active');
            document.getElementById('mainApp').style.display = 'grid';
            
            // Update UI with user info
            document.getElementById('userAvatar').textContent = profile.name[0].toUpperCase();
            document.getElementById('currentLangName').textContent = profile.targetLanguage;
            
            const flags = {
                Spanish: '🇪🇸', French: '🇫🇷', German: '🇩🇪',
                Italian: '🇮🇹', Portuguese: '🇵🇹', Japanese: '🇯🇵'
            };
            document.getElementById('languageBadge').innerHTML = `
                <span>${flags[profile.targetLanguage] || '🌍'}</span>
                <span id="currentLangName">${profile.targetLanguage}</span>
            `;
            
            loadConversation();
            document.getElementById('messageInput').focus();
        }

        async function logout() {
            if (confirm('Sign out? Your progress will be saved.')) {
                try {
                    if (sessionId) {
                        await fetch(`${API_URL}/api/auth/logout`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sessionId })
                        });
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                }
                
                localStorage.removeItem('speakeasy_session');
                localStorage.removeItem('speakeasy_user');
                localStorage.removeItem('speakeasy_profile');
                location.reload();
            }
        }

        // Chat Functions
        function addTranscriptLine(speaker, text) {
            const transcript = document.getElementById('transcript');
            const div = document.createElement('div');
            div.className = `transcript-line ${speaker}`;
            div.innerHTML = `
                <div class="speaker-label ${speaker}">${speaker === 'teacher' ? 'Teacher' : 'You'}</div>
                <div class="transcript-text">${text}</div>
            `;
            transcript.appendChild(div);
            transcript.scrollTop = transcript.scrollHeight;
        }

        function showTyping() {
            const transcript = document.getElementById('transcript');
            const div = document.createElement('div');
            div.id = 'typingIndicator';
            div.className = 'transcript-line teacher';
            div.innerHTML = `
                <div class="speaker-label teacher">Teacher</div>
                <div class="transcript-text">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            transcript.appendChild(div);
            transcript.scrollTop = transcript.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        function setTeacherStatus(text, cssClass = '') {
            const status = document.getElementById('teacherStatus');
            status.textContent = text;
            status.className = 'teacher-status ' + cssClass;
        }

        function animateMouth(start) {
            const mouth = document.getElementById('teacherMouth');
            const tongue = document.getElementById('teacherTongue');
            if (start) {
                mouth.classList.add('talking');
                tongue.classList.add('talking');
                setTeacherStatus('Speaking...', 'speaking');
            } else {
                mouth.classList.remove('talking');
                tongue.classList.remove('talking');
                setTeacherStatus('Ready to help!');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            addTranscriptLine('user', message);
            input.value = '';
            input.style.height = 'auto';
            
            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            showTyping();
            
            try {
                const response = await fetch(`${API_URL}/api/practice/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        targetLanguage: profile.targetLanguage,
                        userLevel: profile.level || 'beginner',
                        useVoice: true
                    })
                });
                
                const data = await response.json();
                hideTyping();
                
                const reply = data.response || 'I\'m sorry, I didn\'t catch that.';
                addTranscriptLine('teacher', reply);
                
                // Play OpenAI TTS audio if available
                if (data.audioBuffer) {
                    await playOpenAIAudio(data.audioBuffer);
                } else {
                    // Fallback to browser TTS
                    await speakWithMouth(reply, profile.targetLanguage);
                }
                
                // Save conversation
                saveMessage('user', message);
                saveMessage('assistant', reply);
                
            } catch (error) {
                hideTyping();
                animateMouth(false);
                console.error(error);
                addTranscriptLine('teacher', '⚠️ Connection error. Please try again.');
            } finally {
                btn.disabled = false;
                input.focus();
            }
        }

        async function playOpenAIAudio(base64Audio) {
            return new Promise((resolve) => {
                try {
                    const audioBlob = new Blob([
                        Uint8Array.from(atob(base64Audio), c => c.charCodeAt(0))
                    ], { type: 'audio/mp3' });
                    
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    audio.onplay = () => animateMouth(true);
                    audio.onended = () => {
                        animateMouth(false);
                        URL.revokeObjectURL(audioUrl);
                        resolve();
                    };
                    audio.onerror = () => {
                        animateMouth(false);
                        URL.revokeObjectURL(audioUrl);
                        resolve();
                    };
                    
                    audio.play();
                } catch (error) {
                    console.error('Audio playback error:', error);
                    resolve();
                }
            });
        }

        async function speakWithMouth(text, lang) {
            if (!('speechSynthesis' in window)) return;
            
            return new Promise((resolve) => {
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.95;
                utterance.pitch = 1.0;
                
                const voices = window.speechSynthesis.getVoices();
                const langMap = { 
                    Spanish: 'es', French: 'fr', German: 'de', 
                    Italian: 'it', Portuguese: 'pt', Japanese: 'ja' 
                };
                const langPrefix = langMap[lang] || 'en';
                
                // Find FEMALE voice
                const matching = voices.filter(v => v.lang.startsWith(langPrefix));
                const femaleVoice = matching.find(v => 
                    v.name.toLowerCase().includes('female') ||
                    v.name.toLowerCase().includes('woman') ||
                    v.name.includes('Google') ||
                    v.name.includes('Samantha') ||
                    v.name.includes('Victoria') ||
                    v.name.includes('Karen') ||
                    v.localService === false
                );
                
                utterance.voice = femaleVoice || matching[0] || voices[0];
                
                utterance.onstart = () => animateMouth(true);
                utterance.onend = () => { animateMouth(false); resolve(); };
                utterance.onerror = () => { animateMouth(false); resolve(); };
                
                window.speechSynthesis.speak(utterance);
            });
        }

        function saveMessage(role, content) {
            const history = JSON.parse(localStorage.getItem(`chat_${user.id}`) || '[]');
            history.push({ role, content, time: Date.now() });
            localStorage.setItem(`chat_${user.id}`, JSON.stringify(history));
        }

        function loadConversation() {
            const history = JSON.parse(localStorage.getItem(`chat_${user.id}`) || '[]');
            history.forEach(msg => {
                if (msg.role === 'user') addTranscriptLine('user', msg.content);
                if (msg.role === 'assistant') addTranscriptLine('teacher', msg.content);
            });
        }

        function clearChat() {
            if (confirm('Clear all messages?')) {
                document.getElementById('transcript').innerHTML = '';
                localStorage.setItem(`chat_${user.id}`, '[]');
                addTranscriptLine('teacher', 'Chat cleared. Let\'s start fresh!');
            }
        }

        // Input handlers
        const input = document.getElementById('messageInput');
        if (input) {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 120) + 'px';
            });
        }
    </script>
</body>
</html>